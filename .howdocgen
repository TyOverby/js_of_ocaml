#!/bin/bash
set -x

# NOTE redirections have to be done this way because:
# 1. Travis doesn't deploy symlinks (https://github.com/travis-ci/dpl/issues/912)
# 2. GitHub Pages uses symlinks to change the displayed page but the URL is not
#    updated. Since the links generated by html_of_wiki are relative and dependant
#    of the location of the file, the links from the redirected page are all wrong.
# `make-redir A B' creates B which redirects to A using `http-equiv'.
make-redir() {
    cat >$2 <<EOF
<!DOCTYPE html>
<html>
    <head><meta http-equiv="refresh" content="0; URL=$1" /></head>
    <body></body>
</html>
EOF
}

make-man-redir() {
    local dir="$(pwd)/_doc/$2/manual"
    mkdir -p "$dir"
    cd "_doc/$1/manual"
    find . -type f | while read -r f; do
        make-redir "../../$1/manual/$f" "$dir/$f"
    done
    cd - 2>&1 >/dev/null
}

LATEST=$(find doc -maxdepth 1 -type d -not -name doc -not -name dev -exec basename {} \; | sort -nr | head -n 1)

export OCAML_VERSION=4.06
export PACKAGE=
wget https://raw.githubusercontent.com/ocaml/ocaml-travisci-skeleton/master/.travis-ocaml.sh
bash -ex .travis-ocaml.sh
eval $(opam env)

git clone https://github.com/ocsigen/html_of_wiki.git
opam pin add -y html_of_wiki html_of_wiki

# wget https://raw.githubusercontent.com/ocsigen/ocsigen.github.io/master/template.wiki
# TODO when every project's CI will run HOW for its docs, uncomment the line above,
# remove the 5 following lines and `git rm' the file doc/template.wiki.
wget https://raw.githubusercontent.com/ocsigen/ocsigen.github.io/e6b93e987b75be99e8ef30601460f60028c615fd/css/style.css
wget https://raw.githubusercontent.com/ocsigen/ocsigen.github.io/e6b93e987b75be99e8ef30601460f60028c615fd/img/search.svg
mkdir tmp
mv style.css tmp
mv search.svg tmp

f=$(mktemp)
cat >$f <<EOF
{
    "project": "js_of_ocaml",
    "api": "api",
    "menu": true,
    "templates": ["doc/template.wiki"],
    "manual": "manual"
}
EOF
quickdop -f doc _doc -t json -c $f -viu

make-redir "$LATEST/manual/intro" _doc/index.html
make-man-redir 1.4 1.0.9
make-man-redir 1.4 1.1.1
make-man-redir 1.4 1.2
make-man-redir 1.4 1.3
make-man-redir 2.4.1 2.0
make-man-redir 2.4.1 2.1
make-man-redir 2.4.1 2.2
make-man-redir 2.4.1 2.3
make-man-redir 2.4.1 2.4

# TODO Also remove that line.
mv tmp _doc
